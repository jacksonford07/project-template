---
description: Stale data detection and refresh patterns
---
# Stale Data Detection

## Critical Insight: Current-Day Data is Incomplete

**Problem**: Data for TODAY may be incomplete until end of day.
**Solution**: Always refresh current-day data, cache historical data.

## Staleness Policy

```typescript
// Current-day data
CURRENT_DAY: 0  // Always stale (always refetch)

// Historical data
HISTORICAL: Infinity  // Never stale (cached forever)

// Profiles
PROFILE_DATA: 24 * 60 * 60 * 1000  // 24 hours

// Relationships
RELATIONSHIPS: 7 * 24 * 60 * 60 * 1000  // 7 days
```

## Pattern: Check if Data is Stale

```tsx
import { isDataStale, isToday } from '@/lib/staleness-policy';

const records = await prisma.data.findMany({ ... });

const fresh = [];
const stale = [];

for (const record of records) {
  if (isDataStale(record.date, record.lastFetchedAt)) {
    stale.push(record);  // Needs refresh
  } else {
    fresh.push(record);  // Can use cached
  }
}

// Refetch stale + missing dates
const datesToFetch = [...missingDates, ...staleDates];
```

## Rules

- ALWAYS refresh current-day data
- NEVER refresh historical data (immutable)
- Check timestamps before refetching
- Don't cache current-day as "complete"
