---
description: Database-first APIs with external fallback
---
# Smart Sync Pattern

## The Pattern

All `/api/internal/*` routes follow this:

```typescript
export async function GET(req: NextRequest): Promise<NextResponse> {
  // 1. Check database first (instant)
  const dbData = await prisma.model.findMany({
    where: { deletedAt: null }
  });

  if (dbData.length > 0) {
    return NextResponse.json({
      data: dbData,
      source: 'database'
    });
  }

  // 2. Database empty - auto-sync from external API
  const apiToken = req.headers.get('x-api-token');

  if (apiToken) {
    const apiData = await fetchFromExternalAPI(apiToken);
    await prisma.model.createMany({ data: apiData });
    return NextResponse.json({
      data: apiData,
      source: 'api',
      synced: true
    });
  }

  // 3. No auto-sync possible
  return NextResponse.json({
    data: [],
    needsSync: true
  });
}
```

## Benefits

- **First load**: Auto-populated from external API (seamless UX)
- **Subsequent loads**: Instant database reads
- **Performance**: ~90% reduction in external API calls
- **Reliability**: Works even when external API is down

## Rules

- Always check database first
- Support optional auto-sync with delegation token
- Return helpful flags (`source`, `synced`, `needsSync`)
- Graceful fallback if external API unavailable
