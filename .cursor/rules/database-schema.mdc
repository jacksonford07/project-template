---
description: Database schema rules and patterns
globs: **/prisma/**
---
# Database Schema Rules

## Soft Deletes - ALWAYS

All tables MUST have:
```prisma
deletedAt DateTime? // Never hard delete data
```

**Rule**: Never hard delete - always soft delete with `deletedAt`.

## Standard Timestamps

Every table should have:
```prisma
createdAt      DateTime @default(now())
updatedAt      DateTime @updatedAt
deletedAt      DateTime?
```

For sync tracking, add:
```prisma
lastSyncedAt   DateTime?  // When synced from external API
lastFetchedAt  DateTime?  // When last fetched
```

## Junction Tables Pattern

For M:M relationships:
```prisma
model UserProject {
  id        Int       @id @default(autoincrement())
  userId    String    // FK to User
  projectId String    // FK to Project
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete

  user      User      @relation(fields: [userId], references: [id])
  project   Project   @relation(fields: [projectId], references: [id])

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}
```

## ID Conventions

- **Internal records**: CUID `@id @default(cuid())`
- **External IDs**: Store as `externalId String? @unique`
- **Relationships**: Auto-increment integers

## Observability Tables

Include these for production monitoring:
```prisma
model ErrorLog {
  id            Int       @id @default(autoincrement())
  timestamp     DateTime  @default(now())
  level         String    // 'error' | 'fatal'
  context       String    // Route/service name
  message       String
  stack         String?   @db.Text
  userId        String?
  requestUrl    String?
  requestMethod String?
  metadata      Json?
  resolved      Boolean   @default(false)
  resolvedAt    DateTime?
}

model PerformanceMetric {
  id         Int      @id @default(autoincrement())
  timestamp  DateTime @default(now())
  route      String
  method     String
  duration   Int      // milliseconds
  userId     String?
  statusCode Int
  cached     Boolean  @default(false)
}
```
